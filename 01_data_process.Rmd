---
title: "01_data_process"
author: "Levente Ronai"
output: html_document
---


```{r, message = F, warning = F}

options(scipen = 999)

### loading packages

library(psych)
library(tidyverse)
library(dplyr)
library(lme4)
library(lmerTest)
library(lavaan)
library(sjPlot)
library(car)
library(data.table)
library(semTools)
library(semPlot)
library(lubridate)
library(git2r)
library(naniar)
library(hms)

```

# 1: import and join of datasets of self-reports and behavioural assessments -------------

```{r}

### import datasets of self-reports and behavioural assessments


big_data <- read.csv("data_processed/big_data.csv")

dat_cogtask <- read.csv("data_processed/dat_cogtask.csv")

```


```{r}

### mutate created_esm for using timestamps

big_data <-
  big_data %>% 
  select(hour_esm = hour, everything()) %>% 
  mutate(time_esm = as.POSIXct(created_esm),
         time_esm = as_hms(time_esm),
         hour_esm = hour(time_esm),
         minutes_esm = minute(time_esm))


```

```{r}

dat_cogtask <- 
  dat_cogtask %>%
  select(hour_cog = hour, everything()) %>% 
  rowwise() %>% 
  mutate(minutes_cog = ifelse(!is.na(nback_minutes) | !is.na(gonogo_minutes),
                              round(mean(c(nback_minutes, gonogo_minutes), na.rm = T), digits = 0),
                              NA
                              ))

```



```{r}

### join the two datasets and keep ESM and cogtask responses occured during the same beep and hour (first ESM surveys and than cogtasks)

big_data <- 
  big_data %>% 
  left_join(dat_cogtask, by = c("session_esm", "day", "beep"))

```


```{r}

big_data <- 
  big_data %>%
  mutate(min_bug = as.numeric(!minutes_cog > minutes_esm),
         hour_bug = as.numeric(!hour_cog >= hour_esm))
```

```{r}

# big_data %>% 
#   filter(hour_bug == T) %>%
#   select(id_esm, created_esm, hour_cog, minutes_cog, hour_esm, minutes_esm, day, beep, date_cogtask, date_esm) # %>% 
  # view()

```



```{r}

### if esm and cogtask hours or minutes do not match (due bugs in formr.org), replace cogtask results with NA's (only 36 trials in sum)

big_data <- 
  big_data %>%
  mutate(gonogo_dprime = ifelse(min_bug == 1 | hour_bug == 1,
                                NA,
                                gonogo_dprime),
         gonogo_corr_rt_median = ifelse(min_bug == 1 | hour_bug == 1,
                                NA,
                                gonogo_corr_rt_median),
         nback_dprime = ifelse(min_bug == 1 | hour_bug == 1,
                                NA,
                                nback_dprime),
         nback_corr_rt_median = ifelse(min_bug == 1 | hour_bug == 1,
                                NA,
                                nback_corr_rt_median),
         
         )
```

# 2: preparing pre-cleaned dataset, screening participants ------------------

```{r}

### selection of relevant variables and filter incomplete three-day blocks (marked with NA) and re-naming of main dataset

dat_cleaned <- 
  big_data %>% 
  select(id_esm, session_esm, created_esm, age, gender, edu, city, start_date, date_esm, date_cogtask,
         day, beep, event_pleasantness, sad:active, homeo_hungry, coffee, alcohol, 
         contains(c("gonogo", "nback", "mzq_", "mss_", "ple_", "stressor", "depr_sum")), -contains(c("minutes")))

```

```{r}

write.csv(dat_cleaned, "data_processed/dat_cleaned.csv", row.names = F)

```

```{r}

dat_cleaned %>% select(id_esm) %>% summarise(n_distinct(id_esm))

```

```{r}

### making gender variable to be considered as a factor  

dat_cleaned  <-  
  dat_cleaned %>%
  mutate(gender = factor(gender, levels = c(1, 2, 3), labels = c("Female", "Male", "Other")))

```

# 3: parallel analysis, principal component analysis & multilevel CFA

```{r}

### parallel analysis of affective states

# prin <-
#   dat_cleaned %>%
#   select(sad, calm, afraid, unrested, enthusiastic, cheerful, irritated, active, angry)
# 
# (parallel <- fa.parallel(prin, fm = "pa"))
# 
# (principal <-
#     psych::principal(prin, nfactors = 2, rotate = "oblimin"))
# dat_cleaned <-
#   dat_cleaned %>%
#   cbind(as.data.frame(principal$scores)) %>%
#   mutate(negaff_pca = TC1,
#          posaff_pca = TC2) %>%
#   select(-TC1, -TC2)

```

```{r, warning = T}

cfa_posaff <-
  dat_cleaned %>%
  filter(!is.na(date_esm)) %>%
  select(id_esm, date_esm, beep,
         active, enthusiastic, cheerful, calm) %>%
  filter_at(vars(active:calm), all_vars(!is.na(.))) %>%
  distinct() %>%
  ungroup()

cfa_posaff_syntax <- '

  level: 1

      posaff_within   =~    active + enthusiastic + cheerful + calm
      cheerful	~~	calm


  level: 2

      posaff_between   =~    active + enthusiastic + cheerful + calm
      cheerful	~~	calm

'

fit_posaff <- cfa(model = cfa_posaff_syntax, data = cfa_posaff, cluster = "id_esm", std.lv = TRUE, estimator = "ML")

```

```{r, warning = T}

fitMeasures(fit_posaff, c("chisq", "df", "pvalue", "cfi", "tli", "rmsea", "srmr_within", "srmr_between"))

```


```{r, warning = T}

summary(fit_posaff, fit.measures = TRUE, standardize = TRUE)


# modificationindices(fit_posaff) %>%
#   select("lhs", "op", "rhs", "level", "mi") %>%
#   filter(mi > 11) %>%
#   arrange(desc(mi)) %>%
#   head(n = 10) %>%
#   print()

```

```{r, warning = T}
# within-person factor loadings
(inspect(fit_posaff, what = "std")$within$lambda)

# between-person factor loadings
(inspect(fit_posaff, what = "std")$id_esm$lambda)

# reliability of NA model
(reliability(fit_posaff))

```


```{r, warning = T}
# between subject factor score-okat hozz치adni a within subject-ekhez

dat_cfa_lev_2 <-
  cfa_posaff %>%
  select(id_esm) %>%
  distinct() %>%
  cbind(lavPredict(fit_posaff, newdata = cfa_posaff[4:7], level = 2L))

dat_cfa_lev_1 <-
  cfa_posaff %>%
  cbind(lavPredict(fit_posaff, newdata = cfa_posaff[4:7], level = 1L)) %>%
  select(-c(active:calm))

dat_cfa <-
  dat_cfa_lev_1 %>%
  left_join(dat_cfa_lev_2, by = "id_esm") %>%
  mutate(posaff_cfa =  posaff_within + posaff_between)

dat_cleaned <-
  dat_cleaned %>%
  left_join(dat_cfa, by = c("id_esm", "date_esm", "beep"))


```

```{r, warning = T}

cfa_negaff <-
  dat_cleaned %>%
  filter(!is.na(date_esm)) %>%
  select(id_esm, date_esm, beep,
         sad, afraid, unrested, irritated, angry) %>%
  filter_at(vars(sad:angry), all_vars(!is.na(.))) %>%
  distinct() %>%
  ungroup()

cfa_negaff_syntax <- '

  level: 1

      negaff_within   =~    sad + afraid + unrested + irritated + angry
      irritated	~~ angry


  level: 2

      negaff_between   =~    sad + afraid + unrested + irritated + angry
      irritated	~~ angry

'

fit_negaff <- cfa(model = cfa_negaff_syntax, data = cfa_negaff, cluster = "id_esm", std.lv = TRUE, estimator = "ML")

```


```{r, warning = T}
fitMeasures(fit_negaff, c("chisq", "df", "pvalue", "cfi", "tli", "rmsea", "srmr_within", "srmr_between"))
```


```{r, warning = T}

summary(fit_negaff, fit.measures = TRUE, standardize = TRUE)


# modificationindices(fit) %>%
#   select("lhs", "op", "rhs", "level", "mi") %>%
#   filter(mi > 11) %>%
#   arrange(desc(mi)) %>%
#   head(n = 10) %>%
#   print()

```

```{r, warning = T}
# within-person factor loadings
(inspect(fit_negaff, what = "std")$within$lambda)

# between-person factor loadings
(inspect(fit_negaff, what = "std")$id_esm$lambda)

# reliability of NA model
(reliability(fit_negaff))

```


```{r, warning = T}
# between subject factor score-okat hozz치adni a within subject-ekhez

dat_cfa_lev_2 <-
  cfa_negaff %>%
  select(id_esm) %>%
  distinct() %>%
  cbind(lavPredict(fit_negaff, newdata = cfa_negaff[4:8], level = 2L))

dat_cfa_lev_1 <-
  cfa_negaff %>%
  cbind(lavPredict(fit_negaff, newdata = cfa_negaff[4:8], level = 1L)) %>%
  select(-c(sad:angry))

dat_cfa <-
  dat_cfa_lev_1 %>%
  left_join(dat_cfa_lev_2, by = "id_esm") %>%
  mutate(negaff_cfa =  negaff_within + negaff_between)

dat_cleaned <-
  dat_cleaned %>%
  left_join(dat_cfa, by = c("id_esm", "date_esm", "beep"))


```

# ple

```{r, warning = T}

cfa_ple <-
  dat_cleaned %>%
  filter(!is.na(date_esm)) %>%
  select(id_esm, date_esm, beep,
         ple_control, ple_strange, ple_thoughts, ple_suspicion,
         ple_treatment, ple_perception, ple_thougtscontrol, ple_familiarstrange) %>%
  filter_at(vars(ple_control:ple_familiarstrange), all_vars(!is.na(.))) %>%
  distinct() %>%
  ungroup()

cfa_ple_syntax <- '

  level: 1

      ple_within   =~    ple_control + ple_strange + ple_thoughts + ple_suspicion +
                         ple_treatment + ple_perception + ple_thougtscontrol + ple_familiarstrange
                         
                         ple_perception	~~	ple_familiarstrange
                         ple_thoughts	~~	ple_familiarstrange


  level: 2

      ple_between   =~   ple_control + ple_strange + ple_thoughts + ple_suspicion +
                         ple_treatment + ple_perception + ple_thougtscontrol + ple_familiarstrange
                         
                        ple_control	~~	ple_strange

'

fit_ple <- cfa(model = cfa_ple_syntax, data = cfa_ple, cluster = "id_esm", std.lv = TRUE, estimator = "MLR")

```


```{r, warning = T}
fitMeasures(fit_ple, c("chisq", "df", "pvalue", "cfi", "tli", "rmsea", "srmr_within", "srmr_between"))
```


```{r, warning = T}

summary(fit_ple, fit.measures = TRUE, standardize = TRUE)


modificationindices(fit_ple) %>%
  select("lhs", "op", "rhs", "level", "mi") %>%
  filter(mi > 11) %>%
  arrange(desc(mi)) %>%
  head(n = 10) %>%
  print()

```

```{r, warning = T}

# within-person factor loadings
(inspect(fit_ple, what = "std")$within$lambda)

# between-person factor loadings
(inspect(fit_ple, what = "std")$id_esm$lambda)

# reliability of NA model
(reliability(fit_ple))

```


```{r, warning = T}
# between subject factor score-okat hozz치adni a within subject-ekhez

dat_ple_lev_2 <-
  cfa_ple %>%
  select(id_esm) %>%
  distinct() %>%
  cbind(lavPredict(fit_ple, newdata = cfa_ple[4:11], level = 2L))

dat_ple_lev_1 <-
  cfa_ple %>%
  cbind(lavPredict(fit_ple, newdata = cfa_ple[4:11], level = 1L)) %>%
  select(-c(ple_control:ple_familiarstrange))

dat_ple <-
  dat_ple_lev_1 %>%
  left_join(dat_ple_lev_2, by = "id_esm") %>%
  mutate(ple_cfa =  ple_within + ple_between)

dat_cleaned <-
  dat_cleaned %>% 
  left_join(dat_ple, by = c("id_esm", "date_esm", "beep"))


```

# cronbach alpha for mss (exclude #10 and #5 due to negative variances)

```{r}
# positive schizotypy: 2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35, 38
mss_pos <- 
  dat_cleaned %>%
  select(id_esm, MSS_BH_8, MSS_BH_11, MSS_BH_14, 
           MSS_BH_23, MSS_BH_32, MSS_BH_20, MSS_BH_26, MSS_BH_29, MSS_BH_2, MSS_BH_38, MSS_BH_17, MSS_BH_35) %>% 
  # MSS_BH_5
  distinct() %>% 
  select(-id_esm)

# negative schizotypy: 1, 4R, 7, 10R, 13, 16, 19, 22, 25R, 28, 31, 34, 37R
mss_neg <- 
  dat_cleaned %>%
  select(id_esm, MSS_BH_1, MSS_BH_28, MSS_BH_13, MSS_BH_34, MSS_BH_19, MSS_BH_4, MSS_BH_7, MSS_BH_16,
             MSS_BH_25, MSS_BH_31, MSS_BH_37, MSS_BH_22) %>% 
  # MSS_BH_10
  distinct() %>% 
  select(-id_esm)

# disorganized schizotypy: 3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36  
mss_dis <- 
  dat_cleaned %>%
  select(id_esm, MSS_BH_3, MSS_BH_6, MSS_BH_9, 
           MSS_BH_12, MSS_BH_15, MSS_BH_18, 
           MSS_BH_21, MSS_BH_24, MSS_BH_27, 
           MSS_BH_30, MSS_BH_36, MSS_BH_33) %>%
  distinct() %>% 
  select(-id_esm)
```


```{r}
psych::alpha(mss_pos, check.keys=TRUE)
```

```{r}
psych::alpha(mss_neg, check.keys=TRUE)
```


```{r}
psych::alpha(mss_dis, check.keys=TRUE)
```

# CFA for MSS

```{r}

# positive schizotypy: 2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35, 38
# affective schizotypy: 1, 28, 13, 19, 34, 
# social schizotypy: 4R, 7, 10R, 16, 22, 25R, 31, 37R

# negative schizotypy: 1, 4R, 7, 10R, 13, 16, 19, 22, 25R, 28, 31, 34, 37R


# disorganized schizotypy: 3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36

dat_cfa_mss <- 
  dat_cleaned %>% 
  dplyr::select(id_esm, contains("MSS_BH")) %>%
  distinct()
  
cfa_mss <- '


mss_pos_score =~  MSS_BH_8 +  MSS_BH_11 +  MSS_BH_14  +
                  MSS_BH_20 + MSS_BH_26 +  MSS_BH_29 +
                  MSS_BH_23 + MSS_BH_32 + MSS_BH_17 + MSS_BH_35 + MSS_BH_38 + MSS_BH_2 # +MSS_BH_5
            
mss_neg_score =~  MSS_BH_19 + MSS_BH_28 + MSS_BH_13 + 
                  MSS_BH_34 + MSS_BH_1 + MSS_BH_4 + MSS_BH_7 + # MSS_BH_10 + 
                  MSS_BH_16 + MSS_BH_25 + MSS_BH_31 + MSS_BH_37 + MSS_BH_22

mss_dis_score =~  MSS_BH_3 + MSS_BH_6 + MSS_BH_9 +
                  MSS_BH_12 + MSS_BH_15 + MSS_BH_18 +
                  MSS_BH_21 + MSS_BH_24 + MSS_BH_27 +
                  MSS_BH_30 + MSS_BH_36 + MSS_BH_33 
                  
'

fit_mss <- cfa(model = cfa_mss, # ordered = T,
                                ordered = c('MSS_BH_1', 'MSS_BH_2',
                                            'MSS_BH_3', 'MSS_BH_4',
                                            'MSS_BH_5', 'MSS_BH_6',
                                            'MSS_BH_7', 'MSS_BH_8',
                                            'MSS_BH_9', 'MSS_BH_10',
                                            'MSS_BH_11', 'MSS_BH_12',
                                            'MSS_BH_13', 'MSS_BH_14',
                                            'MSS_BH_15', 'MSS_BH_16',
                                            'MSS_BH_17', 'MSS_BH_18',
                                            'MSS_BH_19', 'MSS_BH_20',
                                            'MSS_BH_21', 'MSS_BH_22',
                                            'MSS_BH_23', 'MSS_BH_24',
                                            'MSS_BH_25', 'MSS_BH_26',
                                            'MSS_BH_27', 'MSS_BH_28',
                                            'MSS_BH_29', 'MSS_BH_30',
                                            'MSS_BH_31', 'MSS_BH_32',
                                            'MSS_BH_33', 'MSS_BH_34',
                                            'MSS_BH_35', 'MSS_BH_36',
                                            'MSS_BH_37', 'MSS_BH_38'),
                data = dat_cfa_mss, std.lv = TRUE, estimator = "WLSMV")

```

```{r}
fitMeasures(fit_mss, c("chisq", "df", "pvalue", "cfi", "tli",
                   "rmsea", "srmr"))
```

```{r}
modificationindices(fit_mss) %>%
  select("lhs", "op", "rhs", "mi") %>%
  arrange(desc(mi)) %>%
 # head(n = 10) %>%
  print()
```

```{r}

summary(fit_mss, fit.measures = TRUE, standardize = TRUE)

```


```{r}
# reliability of rumination factor (omega)
(reliability(fit_mss))

# factor loadings
inspect(fit_mss, what = "std")$lambda

```

```{r, warning = T}
# between subject factor score-okat hozz치adni a within subject-ekhez

dat_cfa_mss_scores <-
  dat_cfa_mss %>%
  select(id_esm) %>%
  distinct() %>%
  cbind(lavPredict(fit_mss, newdata = dat_cfa_mss[2:39]))

# dat_ple_lev_1 <-
#   dat_cfa_mss %>%
#   cbind(lavPredict(fit_mss, newdata = cfa_ple[4:11], level = 1L)) %>%
#   select(-c(ple_control:ple_familiarstrange))
# 
# dat_ple <-
#   dat_ple_lev_1 %>%
#   left_join(dat_ple_lev_2, by = "id_esm") %>%
#   mutate(ple_cfa =  ple_within + ple_between)

dat_cleaned <-
  dat_cleaned %>% 
  left_join(dat_cfa_mss_scores, by = c("id_esm"))


```

```{r}

# positive schizotypy: 2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35, 38
# negative schizotypy: 1, 4R, 7, 10R, 13, 16, 19, 22, 25R, 28, 31, 34, 37R
# disorganized schizotypy: 3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36

```

```{r}
# ambivalence

dat_cleaned <- 
  dat_cleaned %>% 
  group_by(id_esm, day, beep) %>% 
  mutate(ambivalence = ((posaff_cfa + negaff_cfa)/2) - abs(posaff_cfa - negaff_cfa))
  
```

# 4: centering metrics within- and between individuals ------------

```{r}

### recode pleasantness of the event

dat_cleaned <- 
  dat_cleaned %>% 
  mutate(event_unpleasantness = 8 - event_pleasantness) # %>% 
 # select(-event_pleasantness)

### within-person centering of NA and cogtasks

dat_cleaned <- 
  dat_cleaned %>% 
  group_by(id_esm) %>%
  mutate_at(vars(gonogo_dprime, nback_dprime, gonogo_corr_rt_median, stressor_sum,
                 nback_corr_rt_median, negaff_cfa, posaff_cfa, ple_cfa, event_unpleasantness, event_pleasantness, ambivalence),
            .funs = list(centered = ~ scale(., scale = F, center = T))) %>% 
  distinct()

```


```{r}

dat_cleaned <-
  dat_cleaned %>%
  arrange(id_esm, day, beep) %>%
  group_by(id_esm, day) %>%
  mutate_at(vars(negaff_cfa,
                 ambivalence_centered, 
                 negaff_cfa_centered,
                 posaff_cfa_centered,
                 ple_cfa_centered,
                 event_unpleasantness,
                 event_pleasantness_centered,
                 event_unpleasantness_centered,
                 gonogo_dprime_centered,
                 nback_dprime_centered,
                 gonogo_corr_rt_median_centered,
                 nback_corr_rt_median_centered),
            .funs = list(lag = ~ lag(.))) %>%
  ungroup() %>% 
  distinct()

```



```{r}

### calculating between-level means of NA, PA, event unpleasantness, cogtask variables


dat_cleaned <-
  dat_cleaned %>%
  group_by(id_esm) %>%
  mutate_at(vars(ambivalence,
                 negaff_cfa,
                 posaff_cfa,
                 ple_cfa,
                 event_pleasantness,
                 event_unpleasantness,
                 gonogo_dprime,
                 nback_dprime,
                 gonogo_corr_rt_median,
                 nback_corr_rt_median),
            .funs = list(mean = ~ mean(., na.rm = T))) %>%
  ungroup()

```

# calculation of negativity bias / positivity offset 

```{r}

dat_cleaned <- 
  dat_cleaned %>% 
  group_by(id_esm) %>%
  mutate(z_event = 
           event_pleasantness - (mean(event_pleasantness, na.rm = T)/sd(event_pleasantness, na.rm = T)),
         
         z_event_within_group = ifelse(z_event > 1,
                                 1,
                                 ifelse(z_event < 1 & z_event > -1,
                                        0,
                                        -1))) %>%
  ungroup()

dat_cleaned <- 
  dat_cleaned %>% 
  mutate(gonogo_dprime_grand_centered = as.numeric(scale(gonogo_dprime_mean, center = T, scale = F)),
         nback_dprime_grand_centered  = as.numeric(scale(nback_dprime_mean, center = T, scale = F)),
         event_unpleasantness_grand_centered  = as.numeric(scale(event_unpleasantness_mean, center = T, scale = F)))


dat_cleaned <- 
  dat_cleaned %>% 
  mutate(
    z_event_within_ind = factor(z_event_within_group, levels = c(-1, 0, 1), labels = c("Negative", "Neutral", "Positive")))
  


```


# 5: creation of final dataset for modeling

```{r}

# data for beep models - select model-relevant variables  

model_dat <-
  dat_cleaned %>%
  select(id_esm, session_esm, created_esm, edu, gender, age, city, start_date, day, beep,



         gonogo_dprime, nback_dprime,
         event_unpleasantness, event_unpleasantness_centered, 
         event_pleasantness, event_unpleasantness_lag, event_pleasantness_centered, 
         event_unpleasantness_grand_centered,
         z_event_within_group,

         gonogo_corr_rt_median, gonogo_corr_rt_median_centered, nback_corr_rt_median, nback_corr_rt_median_centered,
         gonogo_dprime_centered, nback_dprime_centered,
         gonogo_dprime_grand_centered,
         nback_dprime_grand_centered,

         negaff_cfa_lag, negaff_cfa_centered, negaff_cfa, negaff_between,
         posaff_cfa, posaff_cfa_centered,
         ple_cfa, ple_cfa_centered, ple_between, 
         ambivalence, ambivalence_centered, ambivalence_centered_lag,

         sad, afraid, unrested, irritated, angry,
         ple_control, ple_strange, ple_thoughts,
         ple_suspicion, ple_treatment, ple_thougtscontrol, ple_sum,

         contains(c("_mean", "_lag", "stressor_sum", "depr")),
         mss_dis, mss_pos, mss_neg, 
         mss_dis_score, mss_pos_score, 
         mss_neg_score, 
         #mss_aff_score, mss_soc_score
         mzq_refuse_reflection,
         mzq_emotional_awareness, mzq_psychic_equivalence, mzq_regulate_affect, mzq_sum
         ) %>%

#  filter_at(vars(event_unpleasantness_centered:negaff_centered_lag), all_vars(!is.na(.))) %>%
  distinct() # %>% view()

```

```{r}

write.csv(model_dat, "data_processed/model_dat.csv", row.names = F)

```

